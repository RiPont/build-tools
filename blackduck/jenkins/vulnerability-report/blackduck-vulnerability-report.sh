#!/bin/bash -ex

git clone ssh://git@github.com/couchbaselabs/vulnerability-reviews

if [ ! -d .venv ]; then
    python3 -m venv .venv
fi
source .venv/bin/activate

cd ${WORKSPACE}/build-tools/blackduck/jenkins/vulnerability-report
pip3 install -r requirements.txt

export LANG=en_US.UTF-8

# This script presumes that the "generate-reports" script has already been
# run, as that script populates ${WORKSPACE}/output
./generate-vulnerability-report.py \
    ${PRODUCT} ${VERSION} \
    -s ${WORKSPACE}/output/${PRODUCT}-${VERSION}-${BLD_NUM}-security.csv \
    -r ${WORKSPACE}/output/${PRODUCT}-${VERSION}-${BLD_NUM}-source.csv \
    -d ${WORKSPACE}/vulnerability-reviews

cd ${WORKSPACE}/vulnerability-reviews
git add ${PRODUCT}
git config --global push.default simple
git diff --quiet && git diff --staged --quiet || git commit \
    -m "Update report for ${PRODUCT} ${VERSION}" \
    --author='Couchbase Build Team <build-team@couchbase.com>'
git push
